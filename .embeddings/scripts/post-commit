#!/bin/sh
#
# PlexMCP Embeddings Post-Commit Hook
# Automatically updates embeddings for changed files after each commit
#

EMBEDDINGS_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
PROJECT_ROOT="$(cd "$EMBEDDINGS_DIR/.." && pwd)"

echo "üîÑ Updating embeddings for committed files..."

# Get list of files changed in last commit
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)

if [ -z "$CHANGED_FILES" ]; then
  echo "‚úì No files changed, skipping update"
  exit 0
fi

# Count changed files
FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
echo "üìù $FILE_COUNT file(s) changed"

# Change to embeddings directory
cd "$EMBEDDINGS_DIR" || exit 1

# Update embeddings for changed files
node dist/update-from-commit.js "$CHANGED_FILES"

if [ $? -eq 0 ]; then
  echo "‚úÖ Embeddings updated successfully"
else
  echo "‚ö†Ô∏è  Embeddings update failed (non-fatal)"
  # Don't fail the commit if embeddings update fails
fi

exit 0
